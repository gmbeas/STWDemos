
@{
    ViewBag.Title = "GeneraRutas";
    Layout = "~/Views/Shared/_Default.cshtml";
}

<div class="row" style="height: 100%;">


    <div class="col-lg-3 col-sm-4 col-xs-4" style="height: 100%;">
        <div class="widget">
            <div class="widget-header bordered-bottom bordered-themesecondary">
                <i class="widget-icon fa fa-tags themesecondary"></i>
                <span class="widget-caption themesecondary">Generar Recorrido</span>

            </div><!--Widget Header-->
            <div class="widget-body">
                <div>
                    <form role="form">
                        <div class="form-group">
                            <label for="e1">Patente</label>
                            <select id="e1" style="width:100%;">
                                <option value="0" />Seleccione
                            </select>

                        </div>

                        <div class="row">
                            <div class="col-lg-7">
                                <label for="id-date-picker-1">Fecha desde</label>
                                <div class="input-group">

                                    <input class="form-control date-picker" id="id-date-picker-1" type="text" data-date-format="dd/mm/yyyy">
                                    <span class="input-group-addon">
                                        <i class="fa fa-calendar"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <label for="timepicker1">Hora desde</label>
                                <div class="input-group">
                                    <input class="form-control" id="timepicker1" type="text">
                                    <span class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div style="height: 10px;"></div>

                        <div class="row">
                            <div class="col-lg-7">
                                <label for="id-date-picker-2">Fecha hasta</label>
                                <div class="input-group">

                                    <input class="form-control date-picker" id="id-date-picker-2" type="text" data-date-format="dd/mm/yyyy">
                                    <span class="input-group-addon">
                                        <i class="fa fa-calendar"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <label for="timepicker2">Hora hasta</label>
                                <div class="input-group">
                                    <input class="form-control" id="timepicker2" type="text">
                                    <span class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        

                        <div style="height: 10px;"></div>
                        <button type="button" class="btn btn-blue" id="rutear">Rutear</button>
                        <button type="button" class="btn btn-blue" id="borrar">Borrar</button>
                    </form>
                </div>
            </div>
        </div>

    </div>



    <div class="col-lg-9 col-sm-8 col-xs-8" style="height: 100%;">
        <div class="widget radius-bordered" style="height: 100%;">
           
            <div class="widget-body" style="height: 100%;">

                <div id="test" style="width: 100%; height: 100%;"></div>
            </div>
        </div>


    </div>

</div>

@section PageScripts{
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script src="~/assets/js/select2/select2.js"></script>
    <!--Bootstrap Date Picker-->
    <script src="~/assets/js/datetime/bootstrap-datepicker.js"></script>

    <!--Bootstrap Time Picker-->
    <script src="~/assets/js/datetime/bootstrap-timepicker.js"></script>






    <script>
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();
        var map;
        var polylineCoordinates = [];
        var polyline;
        var marker;
        var markers = [];
        $("#e1").select2();
        //--Bootstrap Date Picker--
        $('.date-picker').datepicker({
            showMeridian: false
        });

        //--Bootstrap Time Picker--
        $('#timepicker1').timepicker({
            showMeridian: false
        });

        //--Bootstrap Time Picker--
        $('#timepicker2').timepicker({
            showMeridian: false
        });


        $(document).ready(function() {
            $.ajax({
                type: "POST",
                async: false,
                contentType: "application/json; charset=utf-8",
                url: "@Url.Action("GetVehiculos", "Home")",
                data: "{}",
                dataType: "json",
                success: function(res) {
                    for (var i = 0; i < res.length; i++) {
                        $('#e1').append($('<option>', {
                            value: res[i].Id,
                            text: res[i].Patente
                        }));
                    }
                },
                error: function(result) {
                    alert("Error");
                }
            });

            $('#rutear').click(function() {
                var id = $('#e1').val();
                var fechahorain = $('#id-date-picker-1').val() + " " + $('#timepicker1').val();
                var fechahoraout = $('#id-date-picker-2').val() + " " + $('#timepicker2').val();
                $.ajax({
                    type: "POST",
                    async: false,
                    contentType: "application/json; charset=utf-8",
                    url: "@Url.Action("GetPosicionesRuta", "Home")",
                    data: "{'idDispositivo':'" + id + "', 'fechain':'" + fechahorain + "', 'fechaout':'" + fechahoraout + "'}",
                    dataType: "json",
                    success: function (res) {
                        //alert(res.Kilometros);
                        for (var i = 0; i < res.Info.length; i++) {
                           
                            polylineCoordinates.push(new google.maps.LatLng(res.Info[i].Latitud, res.Info[i].Longitud));

                            var icono = "http://labs.google.com/ridefinder/images/mm_20_orange.png";

                            if (i === 0) {
                                icono = "http://www.google.com/mapfiles/dd-start.png";
                            } else if (i === res.Info.length - 1) {
                                icono = "http://www.google.com/mapfiles/dd-end.png";
                            }

                          

                            marker = new google.maps.Marker({
                                position: new google.maps.LatLng(res.Info[i].Latitud, res.Info[i].Longitud),
                                icon: icono,
                                title: res.Info[i].InfoWindows

                            });
                            markers.push(marker);
                          
                        }

                        polyline = new google.maps.Polyline({
                            path: polylineCoordinates,
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2,
                            editable: false
                        });

                        polyline.setMap(map);
                        setAllMap(map);
                    },
                    error: function(result) {
                        alert("Error");
                    }
                });
            });

            $('#borrar').click(function() {

                polyline.setMap(null);
                polylineCoordinates = [];
                deleteMarkers();
            });
        });



        // Sets the map on all markers in the array.
        function setAllMap(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }

        function clearMarkers() {
            setAllMap(null);
        }


        function initialize() {
            directionsDisplay = new google.maps.DirectionsRenderer();
            var chicago = new google.maps.LatLng(-33.381676666666664, -70.642628333333334);
            var mapOptions = {
                zoom: 16,
                center: chicago
            }
            map = new google.maps.Map(document.getElementById('test'), mapOptions);
            //            directionsDisplay.setMap(map);
            //var polylineCoordinates = [
            //    new google.maps.LatLng(-33.381815000000003, -70.642093333333335),
            //    new google.maps.LatLng(-33.381676666666664, -70.642628333333334),
            //    new google.maps.LatLng(-33.381938333333331, -70.642259999999993)
            //];
            //var polyline = new google.maps.Polyline({
            //    path: polylineCoordinates,
            //    strokeColor: '#FF0000',
            //    strokeOpacity: 1.0,
            //    strokeWeight: 2,
            //    editable: false
            //});

            //polyline.setMap(map);

            //var marker, i;

            ////alert(polylineCoordinates.count);

            //for (i = 0; i < 3; i++) {
            //    marker = new google.maps.Marker({
            //        position: polylineCoordinates[i],
            //        map: map
            //    });
            //}
        }


        google.maps.event.addDomListener(window, 'load', initialize);
    </script>

}
